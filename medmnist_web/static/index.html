<!doctype html>
<html lang="el">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hackthon-UOI-2025</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=Space+Grotesk:wght@500;600;700&display=swap"
    rel="stylesheet"
  />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="bg-grid"></div>
  <div class="bg-orb orb-one"></div>
  <div class="bg-orb orb-two"></div>

  <header class="topbar">
    <div class="brand">
      <svg viewBox="0 0 24 24" aria-hidden="true" class="logo">
        <path d="M12 2l3.5 6 6.5 1-4.7 4.6 1.1 6.4L12 17l-6 3.4 1.1-6.4L2.4 9l6.5-1L12 2z"></path>
      </svg>
      <div class="brand-text">
        <span class="brand-title">Hackathon UOI 2025</span>
        <span class="brand-sub">AI Diagnostics Studio</span>
      </div>
      <span class="badge">demo</span>
    </div>
    <nav class="top-links" aria-label="Î’Î±ÏƒÎ¹ÎºÏŒ Î¼ÎµÎ½Î¿Ï">
      <a class="top-link" href="#workspace">Workspace</a>
      <a class="top-link" href="#insights">Info</a>
      <a class="top-link" href="#faq">FAQ</a>
    </nav>
    <button id="themeBtn" class="icon-btn" aria-label="Î•Î½Î±Î»Î»Î±Î³Î® Î¸Î­Î¼Î±Ï„Î¿Ï‚">
      <span class="sun">â˜€ï¸</span><span class="moon">ğŸŒ™</span>
    </button>
  </header>

  <main class="container">
    <section class="hero" id="workspace">
      <div class="hero-copy">
        <span class="eyebrow">AI Radiology Companion</span>
        <h1>Inspect chest X-rays with ready-to-use CheX DenseNet</h1>
        <p>
          Upload a radiograph, receive multi-label findings, and explore Grad-CAM visual explanations â€“ all powered by the pretrained TorchXRayVision DenseNet.
        </p>
        <ul class="hero-highlights">
          <li>
            <span class="dot"></span>
            <span>Live preview </span>
          </li>
          <li>
            <span class="dot"></span>
            <span>Top-3 probability graphs</span>
          </li>
        </ul>
      </div>
      <div class="hero-panels">
        <div class="status-card">
          <span class="status-label">Model</span>
          <strong class="status-value">DenseNet121</strong>
          <span class="status-desc">TorchXRayVision weights</span>
        </div>
        <div class="status-card">
          <span class="status-label">Coverage</span>
          <strong class="status-value">18 findings</strong>
          <span class="status-desc">CheXpert label space</span>
        </div>
      </div>
    </section>

    <section class="workspace">
      <div class="pane upload">
        <div class="pane-header">
          <h2>Upload X-ray</h2>
          <p class="muted">Drag &amp; drop, paste (Ctrl/âŒ˜+V) or Â«selectÂ» a chest radiograph.</p>
        </div>
        <div id="dropzone" class="dropzone" tabindex="0" aria-label="Î ÎµÏÎ¹Î¿Ï‡Î® Î¼ÎµÏ„Î±Ï†Î¿ÏÎ¬Ï‚ Î±ÏÏ‡ÎµÎ¯Î¿Ï…">
          <input id="fileInput" type="file" accept="image/*" hidden />
          <div class="drop-inner">
            <div class="drop-icon">â¬†</div>
            <div>
              <button id="browseBtn" class="btn">Select Image</button>
              <span class="hint">or drag here</span>
            </div>
          </div>
          <img id="preview" class="preview hidden" alt="Î ÏÎ¿ÎµÏ€Î¹ÏƒÎºÏŒÏ€Î·ÏƒÎ· ÎµÎ¹ÎºÏŒÎ½Î±Ï‚" />
        </div>
        <div class="actions">
          <button id="predictBtn" class="btn primary" disabled>Predict</button>
          <button id="clearBtn" class="btn ghost" disabled>Clear</button>
        </div>
        <div id="progress" class="progress hidden" role="status" aria-live="polite">
          <span class="spinner"></span> Processing...
        </div>
      </div>

      <div class="pane results" id="insights">
        <div class="pane-header">
          <h2>Results</h2>
          <p class="muted">Multi-label findings and Grad-CAM focus maps.</p>
        </div>
        <div id="result" class="result">
          <div class="empty">No prediction has been made yet.</div>
        </div>
        <details id="detailsBox" class="details hidden">
          <summary>Probabilities (top-3)</summary>
          <div id="bars" class="bars"></div>
        </details>
        <div id="gradcamViewer" class="cam-viewer hidden" aria-live="polite">
          <div class="cam-header">
            <div>
              <h3>Grad-CAM Focus</h3>
              <p id="gradcamTarget" class="muted"></p>
            </div>
            <button id="toggleCam" class="icon-btn cam-toggle" type="button" aria-pressed="true" aria-label="Toggle Grad-CAM visibility">
              <span class="cam-on">ğŸ‘ï¸</span>
              <span class="cam-off">ğŸš«</span>
            </button>
          </div>
          <div class="cam-grid" id="camGrid">
            <figure class="cam-card">
              <figcaption>Overlay</figcaption>
              <img id="gradcamOverlay" alt="Grad-CAM overlay" />
            </figure>
            <figure class="cam-card">
              <figcaption>Heatmap</figcaption>
              <img id="gradcamHeatmap" alt="Grad-CAM heatmap" />
            </figure>
          </div>
        </div>
        <div class="tips">
          <h3>Tips</h3>
          <ul>
            <li>Use PNG or high-resolution JPEG radiographs.</li>
            <li>The Grad-CAM overlay is resized to 224Ã—224px for visualization.</li>
          </ul>
        </div>
        <p class="disclaimer">âš ï¸ Research demonstration â€” not for clinical use.</p>
      </div>
    </section>

    <section class="faq" id="faq">
      <h2>Frequently Asked Questions</h2>
      <div class="faq-grid">
        <article>
          <h3>Where is the inference performed?</h3>
          <p>The request is sent to the FastAPI backend hosting the TorchXRayVision DenseNet. No images are stored.</p>
        </article>
        <article>
          <h3>Can I switch to dark / light mode?</h3>
          <p>Yes! Use the topic button on the top right. Your choice is saved in the browser.</p>
        </article>
      </div>
    </section>
  </main>

  <footer class="footer">
    <span>Â© 2025 â€“ Hackathon UOI demo</span>
  </footer>

  <script>
    // Î‘Î½ Ï„Î¿ UI ÏƒÎµÏÎ²Î¯ÏÎµÏ„Î±Î¹ Î±Ï€ÏŒ Ï„Î¿ Î¯Î´Î¹Î¿ origin Î¼Îµ Ï„Î¿ FastAPI:
    //const API_URL = "/predict";
    // Î‘Î½ Ï„ÏÎ­Ï‡ÎµÎ¹Ï‚ Î¾ÎµÏ‡Ï‰ÏÎ¹ÏƒÏ„ÏŒ static server: 
    const API_URL = "http://localhost:8080/predict";

    const dropzone = document.getElementById("dropzone");
    const fileInput = document.getElementById("fileInput");
    const browseBtn = document.getElementById("browseBtn");
    const predictBtn = document.getElementById("predictBtn");
    const clearBtn = document.getElementById("clearBtn");
    const preview = document.getElementById("preview");
    const progress = document.getElementById("progress");
    const result = document.getElementById("result");
    const bars = document.getElementById("bars");
    const detailsBox = document.getElementById("detailsBox");
    const gradcamViewer = document.getElementById("gradcamViewer");
    const gradcamOverlay = document.getElementById("gradcamOverlay");
    const gradcamHeatmap = document.getElementById("gradcamHeatmap");
    const gradcamTarget = document.getElementById("gradcamTarget");
    const toggleCam = document.getElementById("toggleCam");
    const camGrid = document.getElementById("camGrid");
    const themeBtn = document.getElementById("themeBtn");

    let currentFile = null;

    // Theme toggle
    const setTheme = (mode) => {
      document.documentElement.dataset.theme = mode;
      localStorage.setItem("ui-theme", mode);
    };
    themeBtn.addEventListener("click", () => {
      const next = (document.documentElement.dataset.theme === "light") ? "dark" : "light";
      setTheme(next);
    });
    setTheme(localStorage.getItem("ui-theme") || "dark");

    // Helpers
    function enableActions(enabled) {
      predictBtn.disabled = !enabled;
      clearBtn.disabled = !enabled;
    }
    function resetUI() {
      currentFile = null;
      preview.src = "";
      preview.classList.add("hidden");
      dropzone.classList.remove("has-image");
      result.innerHTML = `<div class="empty">Î”ÎµÎ½ Î­Ï‡ÎµÎ¹ Î³Î¯Î½ÎµÎ¹ Î±ÎºÏŒÎ¼Î· Ï€ÏÏŒÎ²Î»ÎµÏˆÎ·.</div>`;
      bars.innerHTML = "";
      detailsBox.classList.add("hidden");
      gradcamViewer.classList.add("hidden");
      gradcamOverlay.src = "";
      gradcamHeatmap.src = "";
      gradcamTarget.textContent = "";
      camGrid.classList.remove("hidden");
      toggleCam?.setAttribute("aria-pressed", "true");
      enableActions(false);
    }
    function setPreview(file) {
      const url = URL.createObjectURL(file);
      preview.src = url;
      preview.onload = () => URL.revokeObjectURL(url);
      preview.classList.remove("hidden");
      dropzone.classList.add("has-image");
      enableActions(true);
    }
    function pickFile(file) {
      if (!file || !file.type.startsWith("image/")) {
        alert("Î Î±ÏÎ±ÎºÎ±Î»Ï Î´Î¹Î¬Î»ÎµÎ¾Îµ Î±ÏÏ‡ÎµÎ¯Î¿ ÎµÎ¹ÎºÏŒÎ½Î±Ï‚.");
        return;
      }
      currentFile = file;
      setPreview(file);
    }

    // Drag & Drop
    ["dragenter","dragover"].forEach(ev =>
      dropzone.addEventListener(ev, e => { e.preventDefault(); dropzone.classList.add("drag"); })
    );
    ["dragleave","drop"].forEach(ev =>
      dropzone.addEventListener(ev, e => { e.preventDefault(); dropzone.classList.remove("drag"); })
    );
    dropzone.addEventListener("drop", (e) => {
      const file = e.dataTransfer.files?.[0];
      pickFile(file);
    });

    // Click / Browse
    browseBtn.addEventListener("click", () => fileInput.click());
    dropzone.addEventListener("click", (e) => {
      if (!dropzone.classList.contains("has-image")) fileInput.click();
    });
    fileInput.addEventListener("change", (e) => pickFile(e.target.files?.[0]));

    // Paste (Ctrl/âŒ˜+V)
    window.addEventListener("paste", (e) => {
      const file = Array.from(e.clipboardData.files || [])[0];
      if (file) pickFile(file);
    });

    // Clear
    clearBtn.addEventListener("click", resetUI);

    // Toggle Grad-CAM visibility
    if (toggleCam && camGrid) {
      toggleCam.addEventListener("click", () => {
        const hidden = camGrid.classList.toggle("hidden");
        toggleCam.setAttribute("aria-pressed", (!hidden).toString());
      });
    }

    // Predict
    predictBtn.addEventListener("click", async () => {
      if (!currentFile) return;
      progress.classList.remove("hidden");
      result.innerHTML = "";
      bars.innerHTML = "";
      detailsBox.classList.add("hidden");
      gradcamViewer.classList.add("hidden");
      gradcamOverlay.src = "";
      gradcamHeatmap.src = "";
      gradcamTarget.textContent = "";

      const form = new FormData();
      form.append("file", currentFile);

      try {
        const resp = await fetch(API_URL, { method: "POST", body: form });
        if (!resp.ok) {
          const err = await resp.json().catch(()=>({detail:"Î£Ï†Î¬Î»Î¼Î± server"}));
          throw new Error(err.detail || "Î£Ï†Î¬Î»Î¼Î± server");
        }
        const data = await resp.json();

        // ÎšÏÏÎ¹Î¿ ÎºÎµÎ¯Î¼ÎµÎ½Î¿
        const label = Array.isArray(data.pred_class) ? data.pred_class.join(", ") : data.pred_class;
        result.innerHTML = `
          <div class="pred">
            <div class="pred-label">${label ?? "â€”"}</div>
          </div>
        `;

        // Top-3 bars (Î±Î½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ probs)
        if (data.probs && typeof data.probs === "object") {
          const entries = Object.entries(data.probs);
          entries.sort((a,b) => b[1] - a[1]);
          const top = entries.slice(0, Math.min(3, entries.length));
          top.forEach(([name, p]) => {
            const pct = (p * 100).toFixed(1);
            const row = document.createElement("div");
            row.className = "bar-row";
            row.innerHTML = `
              <div class="bar-label">${name}</div>
              <div class="bar">
                <div class="bar-fill" style="width:${pct}%"></div>
              </div>
              <div class="bar-val">${pct}%</div>
            `;
            bars.appendChild(row);
          });
          detailsBox.classList.remove("hidden");
        }

        if (data.gradcam_overlay && data.gradcam_heatmap) {
          gradcamOverlay.src = `data:image/png;base64,${data.gradcam_overlay}`;
          gradcamHeatmap.src = `data:image/png;base64,${data.gradcam_heatmap}`;
          gradcamTarget.textContent = data.gradcam_target ? `Highlighted class: ${data.gradcam_target}` : "";
          gradcamViewer.classList.remove("hidden");
          camGrid.classList.remove("hidden");
          toggleCam?.setAttribute("aria-pressed", "true");
        }
      } catch (e) {
        result.innerHTML = `<div class="error">âŒ ${e.message || e}</div>`;
        gradcamViewer.classList.add("hidden");
      } finally {
        progress.classList.add("hidden");
      }
    });

    // Init
    resetUI();
  </script>
</body>
</html>
